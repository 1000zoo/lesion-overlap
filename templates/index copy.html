<!doctype html>
<title>Upload a File</title>
<h1>Upload a File</h1>
<p id="error" style="color: red;"></p> <!-- This will display error messages -->
<style>
    #drop_zone {
        width: 200px;
        height: 200px;
        border: 1px solid #ccc;
    }
</style>
<script>
var selectedFile;  // This will hold the file selected by drag&drop or "Choose File" button

function dragOverHandler(ev) {
    console.log('File(s) in drop zone'); 
    ev.preventDefault();
}

function dropHandler(ev) {
    console.log('Drop detected');
    ev.preventDefault();

    if (ev.dataTransfer.items) {
        for (var i = 0; i < ev.dataTransfer.items.length; i++) {
            if (ev.dataTransfer.items[i].kind === 'file') {
                selectedFile = ev.dataTransfer.items[i].getAsFile();
                document.getElementById('file_name').textContent = selectedFile.name;
            }
        }
    } else {
        for (var i = 0; i < ev.dataTransfer.files.length; i++) {
            selectedFile = ev.dataTransfer.files[i];
            document.getElementById('file_name').textContent = selectedFile.name;
        }
    } 
}

function chooseFile(fileInput) {
    selectedFile = fileInput.files[0];
    document.getElementById('file_name').textContent = selectedFile.name;
}

function uploadFile() {
    if (!selectedFile) {
        document.getElementById('error').textContent = 'No file selected';
        return;
    }

    var fileExtension = selectedFile.name.split('.').pop().toLowerCase();
    if (fileExtension !== 'nii' && fileExtension !== 'gz') {
        document.getElementById('error').textContent = 'Allowed file types are .nii';
        return;
    }

    var url = '/';  // Server-side endpoint
    var xhr = new XMLHttpRequest();
    var formData = new FormData();
    
    xhr.open('POST', url, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
            var response = JSON.parse(xhr.responseText);
            if (response.redirect) {
                window.location.href = response.redirect;
            } else if (response.error) {
                document.getElementById('error').textContent = response.error;
            }
        }
    };

    formData.append('file', selectedFile);
    xhr.send(formData);
}
</script>
<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
    Drag & Drop files here
</div>
<input type="file" id="file" name="file" onchange="chooseFile(this)">
<p id="file_name"></p>  <!-- This will display the name of the selected file -->
<button onclick="uploadFile()">Upload</button>
